<?php
class JournalStreamWebResourceWebTestCase extends DrupalWebTestCase {
  protected $topic_queue_node;
  function setUp() {
    // Enable any module that you will need in your tests.
    parent::setUp('journalstream_web_resource','devel');
    $web_user = $this->drupalCreateUser(array('create web_resource content', 'edit own web_resource content', 'create topic_queue content', 'edit own topic_queue content'));
    $this->drupalLogin($web_user);
    $this->createTopicQueueNode();
  }

    /**
    * Creates a topic queue node (needed for reference validation)
  */
  protected function createTopicQueueNode() {
    $edit = array();
    $edit["title"] = "Test Topic Queue";
    $this->drupalPost('node/add/topic-queue', $edit, t('Save'));
    $this->topic_queue_node = $this->drupalGetNodeByTitle($edit['title']);
  }

  function debug($data) {
    // The temp directory does vary across multiple simpletest instances.
    $file = '/tmp/drupal_test_debug.txt';
    if (file_put_contents($file, $data, FILE_APPEND) === FALSE) {
      drupal_set_message(t('The file could not be written.'), 'error');
      return FALSE;
    }
  }
}

class JournalStreamWebResourceNodeCreationTestCase extends JournalStreamWebResourceWebTestCase {

  public static function getInfo(){
    return array(
      'name' => 'JournalStream Web Resource - Node Creation Test Case',
      'description' => 'Tests that a Web Resource node type can been created',
      'group' => 'SCF',
    ); 
  }

  function testWebResourceNodeCreationForm() {
    $this->drupalGet('node/add/web-resource'); 
    $this->assertField('title');
    $this->assertField('body[und][0][value]');
    $this->assertField('field_url[und][0][url]');
    $this->assertField('field_authors[und][0][value]');
    $this->assertField('files[field_screenshot_und_0]');
  }

  function testWebResourceNodeCreation() {
    // Create a node.
    $edit = array();
    $edit["title"] = 'Test Web Resource';
    $edit["body[und][0][value]"] = 'Test Body';
    $edit["field_url[und][0][url]"] = 'http://www.drupal.org/';
    $edit["field_authors[und][0][value]"] = 'Nicholas G. Maloney';
    $this->drupalPost('node/add/web-resource', $edit, t('Save'));
    $this->assertText(t('@title has been created.', array('@title' => $edit['title'])));
    // Check that the node exists in the database.
    $node = $this->drupalGetNodeByTitle($edit['title']);
    $this->assertTrue($node, t('Node found in database.'));
  }
}

class JournalStreamWebResourceImportTestCase extends JournalStreamWebResourceWebTestCase {

  public static function getInfo(){
    return array(
      'name' => 'JournalStream Web Resource - Test Import',
      'description' => 'Tests that a Web Resource node type can been created',
      'group' => 'SCF',
    ); 
  }
  
  function testWebResourceImportFormRender() {
    $url = 'node/' . $this->topic_queue_node->nid . '/web_resource_import';
    $this->drupalGet($url); 
    $this->assertField('files[import_file]');
    $this->assertField('import_raw');
    $this->assertField('queue');
  } 

  function testImportByUrl() {
    require_once('journalstream_web_resource.module');
    $url = 'http://www.drupal.org/';
    $import = journalstream_web_resource_import_by_url($url);
    $this->verbose($import);
    $this->assertTrue($import);
  }
}
  
